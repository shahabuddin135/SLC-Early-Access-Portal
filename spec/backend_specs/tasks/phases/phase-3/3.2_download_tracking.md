```slc
@block TASK 3.2_download_tracking
priority: high
intent: "Implement download event tracking and has_downloaded flag update"
scope: phase-3
depends_on: [3.1_download_endpoint]
estimate: 20
status: todo

content:
  - Implement app/models/download.py:
      class DownloadEvent(SQLModel, table=True):
        __tablename__ = "download_events"
        id: Optional[int] = Field(default=None, primary_key=True)
        user_id: int = Field(foreign_key="users.id", nullable=False)
        downloaded_at: datetime = Field(default_factory=datetime.utcnow)
        ip_address: Optional[str] = Field(default=None, max_length=45)

  - Implement app/services/download_service.py:
      async def record_download(session, user: User, ip: Optional[str] = None):
        - Create DownloadEvent(user_id=user.id, ip_address=ip)
        - Add and commit to session
        - If user.has_downloaded is False:
            - Set user.has_downloaded = True
            - Commit user update
        - Return updated user

  - Update app/routers/download.py to:
      - Extract client IP from Request object
      - Pass IP to download_service.record_download()

acceptance_criteria:
  - Each call to GET /download creates a row in download_events
  - user.has_downloaded is set to True after first download
  - Subsequent downloads still record events but don't re-set the flag
  - IP address is stored when available
@end
```
